flowchart TD
  %% =========================
  %% INPUT
  %% =========================
  A0[PolicyEngineInput\n- call_id\n- customer_id\n- clinic_id\n- appointment_status\n- call_transcript\n- call_summary.summary_text\n- call_summary.key_points\n- clinic_info_formatted (optional)\n- patient_history (optional)] --> S1

  %% =========================
  %% STEP 1: ANALYZE
  %% =========================
  subgraph S1[Step 1: analyze_call]
    direction TB

    S1E1[Expert Attempt 1\n(analyze_call expert prompt)] --> S1S1[Supervisor Review 1]
    S1S1 -->|ACCEPT| S1OUT[(AnalysisResult)\nimportant outputs:\n- inferred_outcome.label\n- inferred_outcome.notes\n- inferred_outcome.summary\n- key_insights[]\n- call_context\n  - appointment_date\n  - appointment_time\n  - provider\n  - missing_information[] (if you use it)\n  - new_info[{type,value}]]

    S1S1 -->|REJECT + patch| S1E2[Expert Attempt 2\n+ supervisor_patch]
    S1E2 --> S1S2[Supervisor Review 2]
    S1S2 -->|ACCEPT| S1OUT

    S1S2 -->|REJECT + patch| S1E3[Expert Attempt 3\n+ supervisor_patch]
    S1E3 --> S1S3[Supervisor Review 3]
    S1S3 -->|ACCEPT| S1OUT

    S1S3 -->|REJECT| S1A[Arbiter\n(analyze_call arbiter prompt)]
    S1A --> S1OUT
  end

  %% =========================
  %% STEP 2: SELECT ACTIONS
  %% =========================
  S1OUT --> S2

  subgraph S2[Step 2: select_actions]
    direction TB

    S2IN[(Inputs to Step 2)\nfrom Step 1:\n- outcome_label = inferred_outcome.label\n- outcome_notes = inferred_outcome.notes\n- insights_formatted = key_insights\n- call_context_json = call_context\n+ appointment_status, call_id\n+ actions_formatted (Available Actions list)\n+ patient_history (optional)] --> S2E1

    S2E1[Expert Attempt 1\n(select_actions expert prompt)] --> S2S1[Supervisor Review 1]
    S2S1 -->|ACCEPT| S2OUT[(ActionSelection)\nimportant outputs:\n- selected_actions[]\n  - action_type\n  - recipient\n  - category\n  - priority\n  - confidence\n- reasoning (if you include it)]

    S2S1 -->|REJECT + patch| S2E2[Expert Attempt 2\n+ supervisor_patch]
    S2E2 --> S2S2[Supervisor Review 2]
    S2S2 -->|ACCEPT| S2OUT

    S2S2 -->|REJECT + patch| S2E3[Expert Attempt 3\n+ supervisor_patch]
    S2E3 --> S2S3[Supervisor Review 3]
    S2S3 -->|ACCEPT| S2OUT

    S2S3 -->|REJECT| S2A[Arbiter\n(select_actions arbiter prompt)]
    S2A --> S2OUT
  end

  %% =========================
  %% STEP 3: GENERATE PARAMS
  %% =========================
  S2OUT --> S3
  S1OUT --> S3

  subgraph S3[Step 3: generate_action_params]
    direction TB

    S3IN[(Inputs to Step 3)\nfrom Step 1:\n- outcome_label\n- outcome_notes\n- key_insights\n- call_context_json (includes new_info)\n+ clinic_info_formatted\nfrom Step 2:\n- selected_actions_formatted\n+ action_param_schemas] --> S3E1

    S3E1[Expert Attempt 1\n(generate_params expert prompt)] --> S3S1[Supervisor Review 1]
    S3S1 -->|ACCEPT| S3OUT[(Final Action Plan)\n- actions[] each has:\n  - recipient/category/action_type (copied)\n  - priority/confidence (copied)\n  - depends_on[]\n  - params{} (generated by schema)]

    S3S1 -->|REJECT + patch| S3E2[Expert Attempt 2\n+ supervisor_patch]
    S3E2 --> S3S2[Supervisor Review 2]
    S3S2 -->|ACCEPT| S3OUT

    S3S2 -->|REJECT + patch| S3E3[Expert Attempt 3\n+ supervisor_patch]
    S3E3 --> S3S3[Supervisor Review 3]
    S3S3 -->|ACCEPT| S3OUT

    S3S3 -->|REJECT| S3A[Arbiter\n(generate_params arbiter prompt)]
    S3A --> S3OUT
  end

  %% =========================
  %% SAVE OUTPUT
  %% =========================
  S3OUT --> Z[Save output\noutput/action_<request_id>.json\n+ print summary]
